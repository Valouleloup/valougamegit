<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Three JS</title>
        <style>
            .container{
                width:500px;
                height:500px;
            }
        </style>
    </head>
 
    <body>
        <h1>Three JS !</h1>

        <div class="players">
        </div>

        <div class="messages">
        </div>

        <div id="container">
        </div>

        <script src="/three.js"></script>
        <script src="/Tween.js"></script>
        <script src="/jquery-1.12.3.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script>

            // 0 - Socket
            var socket = io.connect('http://localhost:8080');

            // 1 - Pseudo
            var pseudo = prompt('Quel est votre pseudo ?');
            socket.emit('nouveau_client', pseudo);
            document.title = pseudo + ' - ' + document.title;

            // 2.1 - Get nouveau player ; ajout dans threejs
            socket.on('nouveau_client', function(newPlayer) {
                geometries[newPlayer.id] = new THREE.PlaneGeometry( tailleCarre, tailleCarre, 1 );
                material = new THREE.MeshBasicMaterial( {color: newPlayer.color, side: THREE.DoubleSide} );

                planes[newPlayer.id] = new THREE.Mesh( geometries[newPlayer.id], material );
                planes[newPlayer.id].position.set(newPlayer.positionX, newPlayer.positionY, 0);
                scene.add( planes[newPlayer.id] );
            });

            // 2.2 - Players, me and init
            var me = {};
            var playersOnline = [];
            socket.on('me', function(infos) {
                me = infos.me;
                playersOnline = infos.players;

                console.log(playersOnline);

                init();
                animate();
            });

            // 4 - Moves
            $(document).keydown(function(event) {
                switch(event.keyCode){
                    case 37:
                        socket.emit('message', {type: 'Move', content: 'Gauche'});
                        break;
                    case 38:
                        socket.emit('message', {type: 'Move', content: 'Haut'});
                        break;
                    case 39:
                        socket.emit('message', {type: 'Move', content: 'Droite'});
                        break;
                    case 40:
                        socket.emit('message', {type: 'Move', content: 'Bas'});
                        break;
                }
            });

            // 5 - Game
            var container;
            var camera, scene, renderer;
            var width = 400; //window.innerWidth
            var height = 300; //window.innerHeight
            var tailleCarre = 1;
            var geometries = [];
            var material;
            var planes = [];

            // 5.1 - Events from players
            socket.on('message', function(message) {

                // Move : Tween
                var timeMove = 40;
                var idPlayerMoving = message.infos.id;
                switch(message.content){
                    case 'Gauche':
                        console.log('Gauche');
                        new TWEEN.Tween( planes[idPlayerMoving].position ).to({
                            x: message.infos.positionX
                        }, timeMove).easing( TWEEN.Easing.Cubic.Out).start();
                        break;
                    case 'Haut':
                        console.log('Haut');
                        new TWEEN.Tween( planes[idPlayerMoving].position ).to({
                            y: message.infos.positionY
                        }, timeMove).easing( TWEEN.Easing.Cubic.Out).start();
                        break;
                    case 'Droite':
                        console.log('Droite');
                        new TWEEN.Tween( planes[idPlayerMoving].position ).to({
                            x: message.infos.positionX
                        }, timeMove).easing( TWEEN.Easing.Cubic.Out).start();
                        break;
                    case 'Bas':
                        console.log('Bas');
                        new TWEEN.Tween( planes[idPlayerMoving].position ).to({
                            y: message.infos.positionY
                        }, timeMove).easing( TWEEN.Easing.Cubic.Out).start();
                        break;
                }
            });

            // 5.2 - ThreeJs
            function init() {

                container = document.getElementById( 'container' );

                camera = new THREE.PerspectiveCamera( 45, width / height, 1, 4000 );
                camera.position.z = 20;

                scene = new THREE.Scene();
                camera.lookAt( scene.position );

                // Pour chaque player
                playersOnline.forEach(function(element){
                    geometries[element.id] = new THREE.PlaneGeometry( tailleCarre, tailleCarre, 1 );
                    material = new THREE.MeshBasicMaterial( {color: element.color, side: THREE.DoubleSide} );

                    planes[element.id] = new THREE.Mesh( geometries[element.id], material );
                    planes[element.id].position.set(element.positionX, element.positionY, 0);
                    scene.add( planes[element.id] );
                });

                renderer = new THREE.WebGLRenderer( { antialias: false } );
                renderer.setPixelRatio( window.devicePixelRatio );
                renderer.setClearColor( 0x4B4C4E );
                renderer.setSize( width, height );

                container.appendChild( renderer.domElement );

                window.addEventListener( 'resize', onWindowResize, false );

            }

            function onWindowResize() {
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize( width, height );
            }

            function animate() {
                requestAnimationFrame( animate );
                render();
            }

            function render() {
                TWEEN.update();
                renderer.render( scene, camera );
            }

        </script>
    </body>
</html>

