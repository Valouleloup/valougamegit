<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Valou Game</title>
        <link rel="stylesheet" href="/css/styles.css">
        <link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400" rel="stylesheet">
        <style>
            .container{
                width:500px;
                height:500px;
            }
        </style>
    </head>
 
    <body>

        <header>
            <div class="center-cont">
                <h1>Valou Game <span class="game-version">v0.3.1</span> </h1>
            </div>
        </header>

        <div id="player-scores">
            <div class="center-cont">
            </div>
        </div>

        <div class="players">
        </div>

        <div class="messages">
        </div>

        <div id="container">
        </div>

        <footer>
            <p>Powered by Valou</p>
        </footer>

        <script src="/three.js"></script>
        <script src="/tween.min.js"></script>
        <script src="/jquery-1.12.3.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script>

            // Init url
            var url = window.location.href;

            // 0 - Socket
            var socket = io.connect(url);

            // 1 - Pseudo
            var pseudo = prompt('Quel est votre pseudo ?');
            socket.emit('nouveau_client', pseudo);
            document.title = document.title + ' - ' + pseudo;

            // 2.1 - Get nouveau player
            var playersOnline = [];
            socket.on('nouveau_client', function(infos) {

                //On redefinit les joueurs en ligne
                playersOnline = infos.players;

                //On rafraichit le panel
                refreshPanel(playersOnline);

                //On rafraichit threejs
                geometries[infos.new.id] = new THREE.PlaneGeometry( tailleCarre, tailleCarre, 1 );
                material = new THREE.MeshBasicMaterial( {color: infos.new.color, side: THREE.DoubleSide} );

                planes[infos.new.id] = new THREE.Mesh( geometries[infos.new.id], material );
                planes[infos.new.id].position.set(infos.new.positionX, infos.new.positionY, 0);
                scene.add( planes[infos.new.id] );
            });

            // 2.2 - Players, me and init
            var me = {};
            socket.on('me', function(infos) {
                me = infos.new;

                // Lancer Threejs quand je connais les players
                init();
                animate();
            });

            // 4 - Moves
            $(document).keydown(function(event) {
                switch(event.keyCode){
                    case 37:
                        socket.emit('message', {type: 'Move', content: 'Gauche'});
                        break;
                    case 38:
                        socket.emit('message', {type: 'Move', content: 'Haut'});
                        break;
                    case 39:
                        socket.emit('message', {type: 'Move', content: 'Droite'});
                        break;
                    case 40:
                        socket.emit('message', {type: 'Move', content: 'Bas'});
                        break;
                }
            });

            // 5 - Game
            var container;
            var camera, scene, renderer;
            var width = 600; //window.innerWidth
            var height = 400; //window.innerHeight
            var tailleCarre = 1;
            var geometries = [];
            var material;
            var planes = [];

            // 5.1 - Events from players
            socket.on('message', function(message) {

                // Move : Tween
                var timeMove = 40;
                var idPlayerMoving = message.infos.id;
                // Refresh position
                new TWEEN.Tween( planes[idPlayerMoving].position ).to({
                    x: message.infos.positionX,
                    y: message.infos.positionY
                }, timeMove).easing( TWEEN.Easing.Cubic.Out).start();
            });

            // 5.2 - ThreeJs
            function init() {

                container = document.getElementById( 'container' );

                camera = new THREE.PerspectiveCamera( 45, width / height, 1, 4000 );
                camera.position.z = 20;

                scene = new THREE.Scene();
                camera.lookAt( scene.position );

                // Pour chaque player
                playersOnline.forEach(function(element){
                    geometries[element.id] = new THREE.PlaneGeometry( tailleCarre, tailleCarre, 1 );
                    material = new THREE.MeshBasicMaterial( {color: element.color, side: THREE.DoubleSide} );

                    planes[element.id] = new THREE.Mesh( geometries[element.id], material );
                    planes[element.id].position.set(element.positionX, element.positionY, 0);
                    scene.add( planes[element.id] );
                });

                renderer = new THREE.WebGLRenderer( { antialias: false } );
                renderer.setPixelRatio( window.devicePixelRatio );
                renderer.setClearColor( 0x3f4651 );
                renderer.setSize( width, height );

                container.appendChild( renderer.domElement );

                window.addEventListener( 'resize', onWindowResize, false );

            }

            function onWindowResize() {
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize( width, height );
            }

            function animate() {
                requestAnimationFrame( animate );
                render();
            }

            function render() {
                TWEEN.update();
                renderer.render( scene, camera );
            }

            // 9 - Deconnexion client
            socket.on('deco_client', function(infos) {

                //On redefinit les joueurs en ligne
                playersOnline = infos.players;

                //On rafraichit le panel
                refreshPanel(playersOnline);

                //On rafraichit threejs
                scene.remove( planes[infos.deco.id] );
            });

            // Final - Functions
            function refreshPanel(players){

                // On vide le panel
                $('#player-scores .center-cont').html('');

                // Pour chaque joueur
                players.forEach(function(element){

                    var htmlCode = '<div class="name-score">';
                    htmlCode += '<p>' + element.pseudo + '<span class="show-score">' + element.score + '</span></p>';
                    htmlCode += '</div>';

                    $('#player-scores .center-cont').append(htmlCode);
                });

            }

        </script>
    </body>
</html>

